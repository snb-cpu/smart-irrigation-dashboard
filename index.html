<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Irrigation Dashboard</title>

  <!-- âœ… MOBILE SUPPORT -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      background: #eef2f7;
      font-family: Arial, sans-serif;
      padding: 12px;
      text-align: center;
      margin: 0;
    }

    h1 {
      color: #2563eb;
      margin-bottom: 18px;
      font-size: 1.4rem;
    }

    .card {
      background: white;
      padding: 16px;
      margin: 12px auto;
      width: 100%;
      max-width: 420px;
      border-radius: 12px;
      box-shadow: 0 0 10px #cbd5e1;
    }

    select, button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
    }

    button {
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: bold;
    }

    button.off {
      background: #dc2626;
    }

    .status {
      font-weight: bold;
      margin-top: 8px;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>

<h1>ðŸŒ± Smart Irrigation Dashboard</h1>

<!-- Sensor Data Card -->
<div class="card">
  <h2>Sensor Data</h2>
  <p class="status">Moisture: <span id="moist">--</span>%</p>
  <p class="status">Temperature: <span id="temp">--</span>Â°C</p>
  <p class="status">Humidity: <span id="hum">--</span>%</p>
</div>

<!-- Relay Control -->
<div class="card">
  <h2>Manual Control</h2>
  <button onclick="setRelay('ON')">Water ON</button>
  <button class="off" onclick="setRelay('OFF')">Water OFF</button>
  <p class="status">Relay: <span id="relayStatus">--</span></p>
</div>

<!-- Mode Control -->
<div class="card">
  <h2>Mode Control</h2>
  <button onclick="setMode('AUTO')">Enable Auto</button>
  <button class="off" onclick="setMode('SEMI_AUTO')">Semi Auto</button>
  <p class="status">Current Mode: <span id="modeStatus">--</span></p>
</div>

<!-- Weather Forecast -->
<div class="card">
  <h2>Weather Forecast</h2>
  <p><strong>Rain Probability:</strong> <span id="rainProb">--</span></p>
  <button onclick="detectLocation()">Update Location Automatically</button>
</div>

<!-- Automatic Watering Settings -->
<div class="card">
  <h2>Automatic Watering Settings</h2>

  <label>Watering Time</label><br>
  <select id="timeSelect" onchange="saveSettings()">
    <option value="5">05:00</option>
    <option value="6">06:00</option>
    <option value="7">07:00</option>
    <option value="18">18:00</option>
    <option value="19">19:00</option>
  </select><br>

  <label>Water Duration (Minutes)</label><br>
  <select id="durationSelect" onchange="saveSettings()">
    <option value="5">5 Minutes</option>
    <option value="10">10 Minutes</option>
    <option value="15">15 Minutes</option>
    <option value="20">20 Minutes</option>
  </select><br>

  <label>Moisture Threshold</label><br>
  <select id="moistureSelect" onchange="saveSettings()">
    <option value="20">20%</option>
    <option value="25">25%</option>
    <option value="30">30%</option>
    <option value="35">35%</option>
  </select><br>

  <label>Rain Probability Threshold</label><br>
  <select id="rainSelect" onchange="saveSettings()">
    <option value="40">40%</option>
    <option value="50">50%</option>
    <option value="60">60%</option>
    <option value="70">70%</option>
  </select>
</div>

<!-- âœ… INSTALL POPUP -->
<div id="installPopup" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  padding: 16px;
  max-width: 340px;
  width: 90%;
  display: none;
  z-index: 9999;
">
  <strong>Install Smart Irrigation</strong>
  <p style="font-size:14px;margin:8px 0;">
    Add this app to your home screen for quick access.
  </p>
  <button onclick="installApp()">Install</button>
  <button class="off" onclick="closeInstallPopup()">Later</button>
</div>

<script>
  // -------------------------
  // Firebase Config
  // -------------------------
  var firebaseConfig = {
    apiKey: "dummy",
    authDomain: "dummy",
    databaseURL: "https://smart-irrigation-final-2743e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "smart-irrigation-final-2743e",
    storageBucket: "dummy",
    messagingSenderId: "dummy",
    appId: "dummy"
  };

  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

  db.ref("sensorData").on("value", snap => {
    let d = snap.val() || {};
    moist.innerText = d.moisture ?? "--";
    temp.innerText = d.temperature ?? "--";
    hum.innerText = d.humidity ?? "--";
  });

  db.ref("control/relay").on("value", snap => {
    relayStatus.innerText = snap.val() ?? "--";
  });

  db.ref("control/mode").on("value", snap => {
    modeStatus.innerText = snap.val() ?? "--";
  });

  function setRelay(state) {
    db.ref("control").update({ mode: "MANUAL", relay: state });
  }

  function setMode(mode) {
    db.ref("control").update({ mode: mode, relay: "OFF" });
  }

  db.ref("weather").on("value", snap => {
    let w = snap.val();
    rainProb.innerText = w && w.rainProbability !== undefined ? w.rainProbability + "%" : "--";
  });

  db.ref("settings").on("value", snap => {
    let s = snap.val() || {};
    timeSelect.value = s.waterHour ?? 6;
    durationSelect.value = s.waterDuration ?? 10;
    moistureSelect.value = s.moistureThreshold ?? 30;
    rainSelect.value = s.rainThreshold ?? 70;
  });

  function saveSettings() {
    db.ref("settings").update({
      waterHour: +timeSelect.value,
      waterDuration: +durationSelect.value,
      moistureThreshold: +moistureSelect.value,
      rainThreshold: +rainSelect.value
    });
  }

  function detectLocation() {
    navigator.geolocation?.getCurrentPosition(pos => {
      db.ref("settings").update({
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude
      });
      alert("Location updated");
    });
  }

  // âœ… INSTALL PROMPT LOGIC
  let deferredPrompt;
  window.addEventListener("beforeinstallprompt", e => {
    e.preventDefault();
    deferredPrompt = e;
    if (!localStorage.getItem("installDismissed")) {
      installPopup.style.display = "block";
    }
  });

  function installApp() {
    installPopup.style.display = "none";
    deferredPrompt.prompt();
    deferredPrompt = null;
  }

  function closeInstallPopup() {
    installPopup.style.display = "none";
    localStorage.setItem("installDismissed", "1");
  }
</script>

</body>
</html>
